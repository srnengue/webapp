<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æãƒ¬ãƒãƒ¼ãƒˆ - ã«ã’ã¾ã£ã—</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
    <style>
        /* analysis2.html ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ¡ç”¨ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            background: white; padding: 25px 30px; border-radius: 20px;
            margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-title { font-size: 24px; color: #333; font-weight: 800; }
        .back-btn {
            background: #667eea; color: white; border: none; padding: 12px 24px;
            border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s;
        }
        .back-btn:hover { background: #5568d3; transform: translateY(-2px); }

        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .insight-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); }
        .insight-icon { font-size: 40px; margin-bottom: 10px; }
        .insight-title { font-size: 16px; color: #666; margin-bottom: 5px; font-weight: 600; }
        .insight-value { font-size: 36px; font-weight: 800; color: #FF6B6B; }
        .insight-desc { font-size: 13px; color: #999; margin-top: 5px; }

        .analysis-section { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); margin-bottom: 25px; }
        .section-title {
            font-size: 20px; color: #333; font-weight: 800; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 3px solid #f0f0f0;
            display: flex; align-items: center; gap: 10px;
        }

        /* ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ */
        .chart-container { position: relative; height: 300px; }

        /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ */
        .keywords-cloud { display: flex; flex-wrap: wrap; gap: 12px; padding: 20px; background: #f8f9fa; border-radius: 15px; min-height: 100px; }
        .keyword-tag {
            padding: 8px 16px; background: white; border: 2px solid #FF6B6B; border-radius: 20px;
            font-weight: 700; color: #FF6B6B; cursor: default; transition: 0.3s;
        }
        .keyword-tag:hover { background: #FF6B6B; color: white; transform: scale(1.05); }

        /* æ„Ÿæƒ…åˆ†æ */
        .sentiment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
        .sentiment-item { background: #f8f9fa; padding: 20px; border-radius: 15px; }
        .sentiment-emoji { font-size: 40px; margin-bottom: 10px; }
        .sentiment-val { font-size: 28px; font-weight: 800; color: #333; }

        .loading { text-align: center; padding: 50px; color: white; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</div>

        <div id="mainContent" style="display:none;">
            <div class="header">
                <div class="header-title" id="pageTitle">åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</div>
                <div style="display:flex; gap:10px;">
                    <button class="back-btn" onclick="location.href='admin.html'">â† ä¸€è¦§ã¸</button>
                    <button class="back-btn" style="background:#28a745;" onclick="goToResults()">ğŸ“‹ çµæœã¸</button>
                </div>
            </div>

            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-icon">ğŸ‘¥</div>
                    <div class="insight-title">ç·å›ç­”æ•°</div>
                    <div class="insight-value" id="totalResp">-</div>
                    <div class="insight-desc">é›†è¨ˆå¯¾è±¡ã®å…¨ãƒ‡ãƒ¼ã‚¿</div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">â­</div>
                    <div class="insight-title">å¹³å‡æº€è¶³åº¦</div>
                    <div class="insight-value" id="avgScore">-</div>
                    <div class="insight-desc">è©•ä¾¡é …ç›®ã®å…¨å¹³å‡</div>
                </div>
                <div class="insight-card">
                    <div class="insight-icon">ğŸ”¥</div>
                    <div class="insight-title">ãƒ›ãƒƒãƒˆãƒˆãƒ”ãƒƒã‚¯</div>
                    <div class="insight-value" style="font-size:24px;" id="topKeyword">-</div>
                    <div class="insight-desc">æœ€ã‚‚è¨€åŠã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</div>
                </div>
            </div>

            <div class="analysis-section">
                <div class="section-title"><span>ğŸ“ˆ</span>å›ç­”æ¨ç§»ãƒˆãƒ¬ãƒ³ãƒ‰</div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="analysis-section">
                <div class="section-title"><span>ğŸ˜Š</span>æ„Ÿæƒ…åˆ†æ (ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹æ¨å®š)</div>
                <div class="sentiment-grid">
                    <div class="sentiment-item">
                        <div class="sentiment-emoji">ğŸ˜Š</div>
                        <div>ãƒã‚¸ãƒ†ã‚£ãƒ–</div>
                        <div class="sentiment-val" id="sentPos">-</div>
                    </div>
                    <div class="sentiment-item">
                        <div class="sentiment-emoji">ğŸ˜</div>
                        <div>ä¸­ç«‹</div>
                        <div class="sentiment-val" id="sentNeu">-</div>
                    </div>
                    <div class="sentiment-item">
                        <div class="sentiment-emoji">ğŸ˜”</div>
                        <div>ãƒã‚¬ãƒ†ã‚£ãƒ–</div>
                        <div class="sentiment-val" id="sentNeg">-</div>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <div class="section-title"><span>ğŸ·ï¸</span>é »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (AIåˆ†æ)</div>
                <div class="keywords-cloud" id="keywordsCloud">
                    <div style="color:#999; width:100%; text-align:center;">åˆ†æä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â˜…ã“ã“ã«GASã®Webã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„
        const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwl8icMgU0epsqXX-uqE4KRA558xH0YECdpPp18rAhnaLqvqyDzoYJr2_cmQs7KHuoWgw/exec';
        
        let currentId = null;
        let chartInstance = null;

        async function init() {
            const params = new URLSearchParams(window.location.search);
            currentId = params.get('id');
            if(!currentId) return location.href = 'admin.html';

            try {
                const res = await fetch(GAS_ENDPOINT);
                const data = await res.json();
                
                const survey = data.surveys.find(s => String(s.id) === String(currentId));
                const responses = data.responses.filter(r => String(r.surveyId) === String(currentId));

                if(!survey || responses.length === 0) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‹ã€å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                    location.href = 'admin.html';
                    return;
                }

                // ç”»é¢è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                renderDashboard(survey, responses);
                renderTrend(survey, responses);
                renderSentiment(survey, responses);
                analyzeKeywords(survey, responses);

            } catch(e) {
                console.error(e);
                alert('åˆ†æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        function goToResults() {
            location.href = `results.html?id=${currentId}`;
        }

        // 1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆåŸºæœ¬æ•°å€¤ï¼‰
        function renderDashboard(survey, responses) {
            document.getElementById('pageTitle').textContent = `ğŸ“Š ${survey.title} - åˆ†æ`;
            document.getElementById('totalResp').textContent = responses.length;

            // ã€Œè©•ä¾¡(rating)ã€ã‚¿ã‚¤ãƒ—ã®è³ªå•ã‚’ã™ã¹ã¦æŠ½å‡ºã—ã¦å¹³å‡ã‚’å‡ºã™
            const ratingQs = survey.questions.filter(q => q.type === 'rating');
            if(ratingQs.length > 0) {
                let total = 0;
                let count = 0;
                responses.forEach(r => {
                    ratingQs.forEach(q => {
                        const val = Number(r[q.id]);
                        if(!isNaN(val) && val > 0) {
                            total += val;
                            count++;
                        }
                    });
                });
                const avg = count ? (total / count).toFixed(1) : '-';
                document.getElementById('avgScore').innerHTML = `${avg}<span style="font-size:18px; color:#999;">/5.0</span>`;
            } else {
                document.getElementById('avgScore').textContent = '-';
                document.querySelector('.insight-desc').textContent = 'è©•ä¾¡å½¢å¼ã®è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“';
            }
        }

        // 2. ãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ•
        function renderTrend(survey, responses) {
            const ctx = document.getElementById('trendChart');
            const dateMap = {};
            
            responses.forEach(r => {
                const d = new Date(r.timestamp).toLocaleDateString();
                dateMap[d] = (dateMap[d] || 0) + 1;
            });

            const labels = Object.keys(dateMap).sort((a,b) => new Date(a) - new Date(b));
            const data = labels.map(d => dateMap[d]);

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å›ç­”æ•°',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // 3. æ„Ÿæƒ…åˆ†æï¼ˆè©•ä¾¡ã‚¹ã‚³ã‚¢ã®åˆ†å¸ƒã‹ã‚‰æ¨æ¸¬ï¼‰
        function renderSentiment(survey, responses) {
            const ratingQs = survey.questions.filter(q => q.type === 'rating');
            
            if(ratingQs.length === 0) {
                ['sentPos','sentNeu','sentNeg'].forEach(id => document.getElementById(id).textContent = '-');
                return;
            }

            let pos=0, neu=0, neg=0, total=0;
            
            // å„å›ç­”è€…ã®å…¨è©•ä¾¡é …ç›®ã®å¹³å‡ã‚’å–ã£ã¦åˆ¤å®š
            responses.forEach(r => {
                let userTotal = 0, userCount = 0;
                ratingQs.forEach(q => {
                    const v = Number(r[q.id]);
                    if(v) { userTotal += v; userCount++; }
                });

                if(userCount > 0) {
                    const userAvg = userTotal / userCount;
                    if(userAvg >= 4) pos++;
                    else if(userAvg >= 3) neu++;
                    else neg++;
                    total++;
                }
            });

            if(total > 0) {
                document.getElementById('sentPos').textContent = Math.round((pos/total)*100) + '%';
                document.getElementById('sentNeu').textContent = Math.round((neu/total)*100) + '%';
                document.getElementById('sentNeg').textContent = Math.round((neg/total)*100) + '%';
            }
        }

        // 4. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ (Kuromoji - å‹•çš„è³ªå•å¯¾å¿œç‰ˆ)
        function analyzeKeywords(survey, responses) {
            const container = document.getElementById('keywordsCloud');
            
            // ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å½¢å¼ã®è³ªå•ã‚’ã™ã¹ã¦å¯¾è±¡ã«ã™ã‚‹
            const textQs = survey.questions.filter(q => q.type === 'text' || q.type === 'textarea');
            
            if(textQs.length === 0) {
                container.innerHTML = '<div style="color:#999;">ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('topKeyword').textContent = '-';
                return;
            }

            // å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
            let allText = "";
            responses.forEach(r => {
                textQs.forEach(q => {
                    if(r[q.id]) allText += r[q.id] + "\n";
                });
            });

            if(!allText.trim()) {
                container.innerHTML = '<div style="color:#999;">ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒååˆ†ã«ã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('topKeyword').textContent = '-';
                return;
            }

            // Kuromojiè¾æ›¸ã®ãƒ­ãƒ¼ãƒ‰ã¨è§£æ
            const DIC_URL = "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/";
            
            kuromoji.builder({ dicPath: DIC_URL }).build((err, tokenizer) => {
                if(err) {
                    console.error(err);
                    container.innerHTML = 'è¾æ›¸ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    return;
                }

                const tokens = tokenizer.tokenize(allText);
                const counts = {};
                // é™¤å¤–ãƒ¯ãƒ¼ãƒ‰è¨­å®š
                const stopWords = new Set([
                    'ã“ã¨','ã‚‚ã®','ã‚ˆã†','ãã‚Œ','ã“ã‚Œ','ã•ã‚“','ã®','ã¦','ã«','ã‚’','ã¯','ãŒ','ã§ã™','ã¾ã™',
                    'ã‚¢ãƒ—ãƒª','æ©Ÿèƒ½','åˆ©ç”¨','ä½¿ç”¨','ãŠé¡˜ã„','æ”¹å–„','ç¢ºèª','è¡¨ç¤º','è¨­å®š','æ„Ÿã˜','å ´åˆ'
                ]);

                tokens.forEach(t => {
                    // åè©ã‹ã¤2æ–‡å­—ä»¥ä¸Šã€ã‹ã¤ã²ã‚‰ãŒãªã®ã¿ã®å ´åˆã¯4æ–‡å­—ä»¥ä¸Šï¼ˆã€Œã„ã‚ã„ã‚ã€ãªã©ã‚’å¼¾ãç°¡æ˜“ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
                    const word = t.surface_form;
                    if(t.pos === 'åè©' && word.length > 1 && !stopWords.has(word)) {
                        // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã¿ã¯é™¤å¤–ï¼ˆIDãªã©ã‚’å¼¾ãï¼‰
                        if(!/^[a-zA-Z]+$/.test(word)) {
                            counts[word] = (counts[word] || 0) + 1;
                        }
                    }
                });

                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 15);
                
                if(sorted.length > 0) {
                    // ãƒˆãƒƒãƒ—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åæ˜ 
                    document.getElementById('topKeyword').textContent = sorted[0][0];

                    container.innerHTML = sorted.map(([word, cnt]) => {
                        const size = Math.min(1.5, 1 + (cnt * 0.1)) + 'em';
                        return `<span class="keyword-tag" style="font-size:${size}">${word} <span style="font-size:0.7em; opacity:0.7;">(${cnt})</span></span>`;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="color:#999;">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                    document.getElementById('topKeyword').textContent = '-';
                }
            });
        }

        window.onload = init;
    </script>
</body>
</html>